<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result - DERMAI</title>
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
    <style>
        #imagePreview {
            display: none;
        }
        #imagePreview img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 1.5rem;
            object-fit: contain;
        }
        #resultDisplay {
            display: none;
        }
        #mapContainer {
            display: none;
            margin-top: 2rem;
        }
        .map-frame {
            width: 100%;
            height: 350px;
            border-radius: 2rem;
            border: 2px solid rgba(240, 138, 99, 0.3);
            overflow: hidden;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        #fileInput {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        #errorDisplay {
            display: none;
        }
    </style>
</head>
<body>
    <div class="logo-header">
        <img src="logo.png.png" alt="DERMAI Logo" class="logo-img">
    </div>
    <div class="container" style="padding: 0 2rem 1rem;">
        <div style="text-align: center; max-width: 800px; margin: 0 auto;">
            <!-- Image Preview -->
            <div id="imagePreview" style="background: linear-gradient(135deg, rgba(240, 138, 99, 0.1) 0%, rgba(240, 138, 99, 0.05) 100%); border-radius: 2rem; padding: 1.5rem; margin-bottom: 2rem; border: 2px solid rgba(240, 138, 99, 0.3);">
                <img id="previewImage" src="" alt="Uploaded Image">
            </div>
            
            <!-- Placeholder when no image -->
            <div id="placeholderPreview" style="background: linear-gradient(135deg, rgba(240, 138, 99, 0.1) 0%, rgba(240, 138, 99, 0.05) 100%); border-radius: 2rem; padding: 1.5rem; margin-bottom: 2rem; border: 2px solid rgba(240, 138, 99, 0.3);">
                <div style="width: 100%; height: 250px; background: rgba(18, 2, 2, 0.5); border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.95rem;">
                    [Uploaded Image Preview]
                </div>
            </div>
            
            <!-- Error Display -->
            <div id="errorDisplay" class="error-box" style="max-width: 600px; width: 100%; margin: 1rem auto;">
                <div class="error-icon">âš </div>
                <h2 class="error-title">Invalid Image</h2>
                <p class="error-message">
                    image is not related to skin disease. Please upload a valid skin lesion image.
                </p>
            </div>
            
            <!-- Result Display -->
            <div id="resultDisplay" class="result-box" style="padding: 1.5rem; margin: 1rem 0;">
                <div class="result-text" style="font-size: 1rem; margin: 0.75rem 0;">
                    <span class="result-label">Disease:</span> <span id="diseaseName">Basal Cell Carcinoma</span>
                </div>
                <div class="result-text" style="font-size: 1rem; margin: 0.75rem 0;">
                    <span class="result-label">Accuracy:</span> <span id="accuracyValue">78.25</span> %
                </div>
                <div class="result-text" style="font-size: 1rem; margin: 0.75rem 0;">
                    <span class="result-label">Medicine:</span> <span id="medicineName">Aldara</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; align-items: center;">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept="image/*">
                    <button onclick="document.getElementById('fileInput').click()" class="btn-primary">
                        choose a Photo
                    </button>
                </div>
                
                <div id="actionLinks" style="display: none; flex-direction: column; gap: 0.75rem; align-items: center; margin-top: 1rem;">
                    <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center;">
                        <a href="#" onclick="showResult(); return false;" class="link-text" style="font-size: 0.95rem;">see result</a>
                        <a href="#" onclick="showClinicsMap(); return false;" class="link-text" style="font-size: 0.95rem;">Look for Clinics</a>
                        <a href="#" onclick="showDoctorsMap(); return false;" class="link-text" style="font-size: 0.95rem;">Find Doctor</a>
                    </div>
                </div>
            </div>
            
            <!-- Map Container -->
            <div id="mapContainer" style="background: linear-gradient(135deg, rgba(240, 138, 99, 0.1) 0%, rgba(240, 138, 99, 0.05) 100%); border-radius: 2rem; padding: 1.5rem; border: 2px solid rgba(240, 138, 99, 0.3);">
                <h3 style="font-family: 'Playfair Display', serif; color: var(--accent-copper); margin-bottom: 1rem; font-size: 1.4rem;">Map View</h3>
                <div class="map-frame">
                    <iframe id="mapFrame" width="100%" height="100%" style="border:0; border-radius: 1.5rem;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
                <p style="margin-top: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                    <a href="#" onclick="closeMap(); return false;" class="link-text">Close Map</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const placeholderPreview = document.getElementById('placeholderPreview');
        const previewImage = document.getElementById('previewImage');
        const resultDisplay = document.getElementById('resultDisplay');
        const errorDisplay = document.getElementById('errorDisplay');
        const actionLinks = document.getElementById('actionLinks');
        const mapContainer = document.getElementById('mapContainer');
        const mapFrame = document.getElementById('mapFrame');

        // Sample results data (in real app, this would come from API)
        const sampleResults = [
            { disease: "Basal Cell Carcinoma", accuracy: 78.25, medicine: "Aldara" },
            { disease: "Melanoma", accuracy: 85.50, medicine: "Keytruda" },
            { disease: "Squamous Cell Carcinoma", accuracy: 72.10, medicine: "5-Fluorouracil" },
            { disease: "Actinic Keratosis", accuracy: 91.30, medicine: "Imiquimod" },
            { disease: "Benign Nevus", accuracy: 95.00, medicine: "No treatment needed" },
            { disease: "Dysplastic Nevus", accuracy: 88.75, medicine: "Surgical excision" },
            { disease: "Seborrheic Keratosis", accuracy: 92.40, medicine: "Cryotherapy" },
            { disease: "Dermatofibroma", accuracy: 89.60, medicine: "Observation" },
            { disease: "Psoriasis", accuracy: 87.20, medicine: "Topical corticosteroids" },
            { disease: "Eczema", accuracy: 83.45, medicine: "Hydrocortisone cream" },
            { disease: "Seborrheic Dermatitis", accuracy: 81.30, medicine: "Ketoconazole" },
            { disease: "Contact Dermatitis", accuracy: 79.80, medicine: "Antihistamines" },
            { disease: "Atopic Dermatitis", accuracy: 86.15, medicine: "Tacrolimus ointment" },
            { disease: "Rosacea", accuracy: 84.90, medicine: "Metronidazole gel" },
            { disease: "Vitiligo", accuracy: 90.25, medicine: "Topical calcineurin inhibitors" }
        ];

        // Function to check if image is likely a skin disease or skin lesion image
        function isSkinImage(file) {
            // First, check if it's actually an image file
            if (!file.type.startsWith('image/')) {
                return false; // Not an image file
            }
            
            const fileName = file.name.toLowerCase();
            
            // Skin disease and skin lesion related keywords (accept if these are present)
            const skinKeywords = [
                'skin', 'lesion', 'dermatology', 'derma', 'dermatoscopic', 'dermoscopic', 'dermoscopy',
                'mole', 'nevus', 'rash', 'carcinoma', 'melanoma', 'basal', 'squamous',
                'actinic', 'keratosis', 'disease', 'medical', 'clinical', 'benign', 'malignant',
                'tumor', 'cancer', 'growth', 'spot', 'patch', 'bump', 'lump', 'wound',
                'ulcer', 'erosion', 'papule', 'nodule', 'plaque', 'macule', 'dermatitis',
                'psoriasis', 'eczema', 'vitiligo', 'rosacea', 'seborrheic', 'atopic',
                'dysplastic', 'dermatofibroma', 'pigment', 'pigmented', 'melanocytic'
            ];
            
            // Check if filename contains skin-related keywords
            const hasSkinKeyword = skinKeywords.some(keyword => fileName.includes(keyword));
            
            // If it has skin-related keywords, accept it immediately
            if (hasSkinKeyword) {
                return true;
            }
            
            // Only reject VERY obvious non-skin patterns (passport photos, selfies, landscapes, etc.)
            const obviousNonSkinPatterns = [
                // Passport/ID photos (very specific)
                'passport', 'selfie', 'portrait', 'face', 'person', 'people', 'human', 'head', 'profile',
                'id', 'identity', 'document',
                
                // Landscape/Nature (very obvious)
                'landscape', 'mountain', 'beach', 'sunset', 'sunrise', 'nature', 'forest', 'tree', 'flower', 'plant',
                
                // Animals (very obvious)
                'animal', 'dog', 'cat', 'bird', 'pet', 'wildlife', 'horse', 'cow',
                
                // Food (very obvious)
                'food', 'meal', 'restaurant', 'dish', 'recipe', 'cooking', 'fruit', 'vegetable',
                
                // Vehicles/Objects (very obvious)
                'car', 'vehicle', 'automobile', 'truck', 'motorcycle', 'bike',
                'building', 'architecture', 'house', 'home', 'room',
                'logo', 'icon', 'screenshot', 'desktop', 'wallpaper', 'background',
                
                // Documents
                'text', 'pdf', 'scan', 'copy'
            ];
            
            // Check if filename contains obvious non-skin patterns
            const hasObviousNonSkinPattern = obviousNonSkinPatterns.some(pattern => fileName.includes(pattern));
            
            // If filename has obvious non-skin patterns, reject it
            if (hasObviousNonSkinPattern) {
                return false;
            }
            
            // Default: Accept the image (show results)
            // Generic image names or unclear filenames are assumed to be skin images
            // This allows all skin disease and skin lesion images to pass
            return true;
        }

        // Function to check image dimensions (to detect passport photos)
        function checkImageDimensions(img, callback) {
            const imgElement = new Image();
            imgElement.onload = function() {
                const width = this.width;
                const height = this.height;
                const aspectRatio = width / height;
                
                // Only reject if it's VERY clearly a passport photo:
                // - Portrait orientation (height > width)
                // - Very tall aspect ratio (like 2:3 or taller)
                // - Typical passport photo dimensions (very specific)
                const isPortrait = height > width;
                const isVeryTall = aspectRatio < 0.6; // Very tall portrait (like 2:3 ratio)
                const isPassportSize = (width >= 300 && width <= 600 && height >= 600 && height <= 1200);
                
                // Only reject if it's VERY clearly a passport photo (very tall portrait with specific size)
                // Most skin disease images are square or slightly rectangular, not very tall portraits
                if (isPortrait && isVeryTall && isPassportSize) {
                    callback(false); // Very likely a passport photo
                } else {
                    callback(true); // Accept - likely a skin disease image
                }
            };
            imgElement.onerror = function() {
                callback(true); // If we can't load image, proceed with filename check
            };
            imgElement.src = img;
        }

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Hide previous results/errors
                resultDisplay.style.display = 'none';
                errorDisplay.style.display = 'none';
                actionLinks.style.display = 'none';
                mapContainer.style.display = 'none';
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageDataUrl = event.target.result;
                    previewImage.src = imageDataUrl;
                    placeholderPreview.style.display = 'none';
                    imagePreview.style.display = 'block';
                    
                    // First check filename
                    const isValidByFilename = isSkinImage(file);
                    
                    if (!isValidByFilename) {
                        // Show error message immediately if filename suggests non-skin image
                        setTimeout(() => {
                            errorDisplay.style.display = 'block';
                            errorDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 500);
                    } else {
                        // If filename is OK, also check image dimensions to detect passport photos
                        checkImageDimensions(imageDataUrl, function(isValidDimensions) {
                            if (!isValidDimensions) {
                                // Image dimensions suggest it's a passport photo
                                setTimeout(() => {
                                    errorDisplay.style.display = 'block';
                                    errorDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 500);
                            } else {
                                // Valid skin disease image - upload to backend and show results
                                uploadImageAndGetResult(file, imageDataUrl);
                            }
                        });
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        function showResult() {
            mapContainer.style.display = 'none';
            resultDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function showClinicsMap() {
            // Google Maps search for dermatology clinics (using embed without API key)
            const query = encodeURIComponent('dermatology clinics');
            // Using Google Maps embed URL that works without API key
            mapFrame.src = `https://www.google.com/maps?q=${query}&output=embed`;
            mapContainer.style.display = 'block';
            mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showDoctorsMap() {
            // Google Maps search for dermatologists
            const query = encodeURIComponent('dermatologist doctor');
            mapFrame.src = `https://www.google.com/maps?q=${query}&output=embed`;
            mapContainer.style.display = 'block';
            mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function closeMap() {
            mapContainer.style.display = 'none';
            mapFrame.src = '';
        }

        // Upload image to backend and save detection result
        async function uploadImageAndGetResult(file, imageDataUrl) {
            try {
                // Get current user
                const currentUser = getCurrentUser();
                const userId = currentUser ? currentUser.id : null;

                // Upload image to backend
                const formData = new FormData();
                formData.append('image', file);
                if (userId) {
                    formData.append('userId', userId);
                }

                const uploadResponse = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const uploadData = await uploadResponse.json();
                
                if (!uploadResponse.ok) {
                    throw new Error(uploadData.error || 'Failed to upload image');
                }

                // Get random detection result (simulating AI)
                setTimeout(() => {
                    const randomResult = sampleResults[Math.floor(Math.random() * sampleResults.length)];
                    
                    // Display results
                    document.getElementById('diseaseName').textContent = randomResult.disease;
                    document.getElementById('accuracyValue').textContent = randomResult.accuracy;
                    document.getElementById('medicineName').textContent = randomResult.medicine;
                    
                    resultDisplay.style.display = 'block';
                    actionLinks.style.display = 'flex';

                    // Save detection result to backend
                    saveDetectionResult(uploadData.imageId, userId, randomResult);
                }, 1000);

            } catch (error) {
                console.error('Upload error:', error);
                // Still show results even if backend fails (for demo purposes)
                setTimeout(() => {
                    const randomResult = sampleResults[Math.floor(Math.random() * sampleResults.length)];
                    document.getElementById('diseaseName').textContent = randomResult.disease;
                    document.getElementById('accuracyValue').textContent = randomResult.accuracy;
                    document.getElementById('medicineName').textContent = randomResult.medicine;
                    
                    resultDisplay.style.display = 'block';
                    actionLinks.style.display = 'flex';
                }, 1000);
            }
        }

        // Save detection result to backend
        async function saveDetectionResult(imageId, userId, result) {
            try {
                await fetch(`${API_BASE_URL}/detection-result`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageId: imageId,
                        userId: userId,
                        disease: result.disease,
                        accuracy: result.accuracy,
                        medicine: result.medicine
                    })
                });
            } catch (error) {
                console.error('Error saving detection result:', error);
                // Fail silently - don't interrupt user experience
            }
        }
    </script>
</body>
</html>

